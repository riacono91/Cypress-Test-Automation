name: Cypress Setup Tests (Ubuntu & Windows)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        if: matrix.os == 'ubuntu-latest'
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      # Install nvm (Node Version Manager) for Windows
      - name: Install nvm for windows
        if: matrix.os == 'windows-latest'  
        shell: powershell
        run: |
          Invoke-WebRequest -Uri https://github.com/coreybutler/nvm-windows/releases/download/1.1.12/nvm-setup.zip -OutFile nvm-setup.zip
          Expand-Archive nvm-setup.zip -DestinationPath C:\nvm
          setx NVM_HOME C:\nvm
          setx NVM_SYMLINK C:\Program Files\nodejs
          $env:NVM_HOME="C:\nvm"
          $env:NVM_SYMLINK="C:\Program Files\nodejs"
          C:\nvm\nvm.exe install 18
          C:\nvm\nvm.exe use 18
          
      - name: Cache Cypress binary
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/Cypress
            C:/Users/runneradmin/AppData/Local/Cypress/Cache
          key: ${{ runner.os }}-cypress-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-cypress-

      - name: Run setup script (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: bash setup.sh

      - name: Run setup script (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cmd /c setup.bat
        shell: cmd


      - name: Verify Cypress binary existence (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "Checking for Cypress binary in Ubuntu..."
          ls ~/.cache/Cypress || exit 1             

      - name: Verify Cypress binary existence (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          echo "Checking for Cypress binary in Windows..."
          powershell -Command "
            # Check if the folder exists
            if (Test-Path 'C:\Users\iacon\AppData\Local\Cypress\Cache') {
              Write-Output 'Cypress Cache folder found.'
              # List the contents of the directory for debugging
              Get-ChildItem 'C:\Users\iacon\AppData\Local\Cypress\Cache'
              # Check if Cypress binary exists in the folder
              if (Test-Path 'C:\Users\iacon\AppData\Local\Cypress\Cache\13.16.1\Cypress\Cypress.exe') {
                Write-Output 'Cypress binary found.'
              } else {
                Write-Error 'Cypress binary not found in cache! Exiting...'
                exit 1
              }
            } else {
              Write-Error 'Cypress Cache folder not found! Exiting...'
              exit 1
            }
          "
        shell: pwsh
        
            
      - name: Run Cypress tests
        run: npx cypress run
